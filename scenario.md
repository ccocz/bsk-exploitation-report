Włamywacz komputerowy na zaatakowanym komputerze instaluje program nmap i za jego pomocą skanuje sieć wewnętrzną firmy, do której jest podłączony zaatakowany komputer. W trakcie tego skanowania udaje mu się znaleźć maszynę, na której zainstalowany jest serwer WWW Apache 2 i phpMyAdmin. Łączy się z tym ostatnim i wypróbowuje kilka typowych par login-hasło, żeby dostać się do bazy Green Forest Banku. Udaje mu się znaleźć parę, pozwalającą na wejście do systemu. Po zalogowaniu włamywacz ściąga zawartość bazy danych i ją kasuje.

todo: check if you can reduce some parts from tcpdump outputs (remove one interface?)

todo: zrobić ich dodatkowe kopie robocze

todo: why there's need for serwer's pcap, meaning of initial ssh

todo: pre-requisetes?

# Data integrity

Before running any of the comments below check if checksums agree with the real sums, i.e.,:

* greenforestbank-router.pcap 

```
diff <(openssl dgst -sha256 greenforestbank-router.pcap | cut -d' ' -f2) <(echo "4f341625b1538cb346c4802ce02c75dd55c4430c64cebfbed4a70216fff5bf95")

diff <(openssl dgst -ripemd160 greenforestbank-router.pcap | cut -d' ' -f2) <(echo "24b85f7e0be6b1abcd66fa7f2a883752a58c1c70")
```

* greenforestbank-serwer.pcap

```
diff <(openssl dgst -sha256 greenforestbank-serwer.pcap | cut -d' ' -f2) <(echo "e8fd832714507166dd558c9e6bbd300cee8a66a32f48e2db191488000402e5c0")
diff <(openssl dgst -ripemd160 greenforestbank-serwer.pcap | cut -d' ' -f2) <(echo "f77dabe77ff0390ff598ec96d706132b19537776")
```

* access.log

```
diff <(openssl dgst -sha256 access.log | cut -d' ' -f2) <(echo "30e325f69de2e37b96263fb59a9b8169cd6ea1a160ee9022f7d0a0c782616c75")
diff <(openssl dgst -ripemd160 access.log | cut -d' ' -f2) <(echo "4b3389fce7565727469c8c5f7715da3c023356be")
```

* auth.log

```
diff <(openssl dgst -sha256 auth.log | cut -d' ' -f2) <(echo "fc9195a33f274ac57ed236f5ff1abd462abb2ad3e290c91f799987291fa187d4")
diff <(openssl dgst -ripemd160 auth.log | cut -d' ' -f2) <(echo "1dfd36235e561815dd22cbdffad56cfa2a5f7d55")
```

Dual checksums i.e., `SHA256` and `RIPMD-160` are used as an insurance against attacks on the single hash function.

# Timeline

## 1) Scanning internal network

Attacker at `15:15:18 (here and below UTC+1)` runs `nmap` in the machine with IP address `172.16.0.2` and discovers `Apache2` and `phpMyAdmin` server with IP 
`192.168.1.2`. This can be proved by running following command on packets' capture on the router:

`tcpdump -i any -r greenforestbank-router.pcap src host 172.16.0.2 | sed -n "1,100p"`

gives output of:

```
reading from file greenforestbank-router.pcap, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144
Warning: interface names might be incorrect
15:15:18.264158 wlp2s0 In  IP 172.16.0.2 > 192.168.0.1: ICMP echo request, id 19245, seq 0, length 8
15:15:18.264159 wlp2s0 In  IP 172.16.0.2 > 192.168.0.2: ICMP echo request, id 543, seq 0, length 8
15:15:18.264160 wlp2s0 In  IP 172.16.0.2 > 192.168.0.3: ICMP echo request, id 29538, seq 0, length 8
15:15:18.264160 wlp2s0 In  IP 172.16.0.2 > 192.168.0.4: ICMP echo request, id 34308, seq 0, length 8
15:15:18.264160 wlp2s0 In  IP 172.16.0.2 > 192.168.0.5: ICMP echo request, id 35468, seq 0, length 8
15:15:18.264160 wlp2s0 In  IP 172.16.0.2 > 192.168.0.6: ICMP echo request, id 11810, seq 0, length 8
15:15:18.264161 wlp2s0 In  IP 172.16.0.2 > 192.168.0.7: ICMP echo request, id 30859, seq 0, length 8
15:15:18.264161 wlp2s0 In  IP 172.16.0.2 > 192.168.0.8: ICMP echo request, id 16715, seq 0, length 8
...
```

From the above output, we can see that ICMP ping is used to locate hosts in the internal network.

## 2) Connecting to phpMyAdmin
At `15:24:16` `nmap` reveals IP `192.168.1.2` of the host where `Apache2` server is running. Attacker establishes connection to the host and tries to find proper URL for `phpMyAdmin` i.e., `/webadmin` and `/admin` followed by `/phpMyAdmin`:

`tcpdump -i -any -r greenforestbank-router.pcap host 172.16.0.2 and host 192.168.1.2 and tcp port 80 | grep 'Flags \[P.\]' | sed -n "1,15p"`

filters out HTTP push packets between attacker and the server and gives the following output:

```
reading from file greenforestbank-router.pcap, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144
Warning: interface names might be incorrect
15:24:16.838805 wlp2s0 In  IP 172.16.0.2.36014 > 192.168.1.2.http: Flags [P.], seq 1:415, ack 1, win 502, options [nop,nop,TS val 4079352240 ecr 1050478194], length 414: HTTP: GET / HTTP/1.1
15:24:16.838814 enp0s25 Out IP 172.16.0.2.36014 > 192.168.1.2.http: Flags [P.], seq 1:415, ack 1, win 502, options [nop,nop,TS val 4079352240 ecr 1050478194], length 414: HTTP: GET / HTTP/1.1
15:24:16.842002 enp0s25 In  IP 192.168.1.2.http > 172.16.0.2.36014: Flags [P.], seq 1:3381, ack 415, win 506, options [nop,nop,TS val 1050478198 ecr 4079352240], length 3380: HTTP: HTTP/1.1 200 OK
15:24:16.842012 wlp2s0 Out IP 192.168.1.2.http > 172.16.0.2.36014: Flags [P.], seq 1:3381, ack 415, win 506, options [nop,nop,TS val 1050478198 ecr 4079352240], length 3380: HTTP: HTTP/1.1 200 OK
15:24:30.003831 wlp2s0 In  IP 172.16.0.2.36016 > 192.168.1.2.http: Flags [P.], seq 1:331, ack 1, win 502, options [nop,nop,TS val 4079365404 ecr 1050491358], length 330: HTTP: GET /webadmin HTTP/1.1
15:24:30.003837 enp0s25 Out IP 172.16.0.2.36016 > 192.168.1.2.http: Flags [P.], seq 1:331, ack 1, win 502, options [nop,nop,TS val 4079365404 ecr 1050491358], length 330: HTTP: GET /webadmin HTTP/1.1
15:24:30.005072 enp0s25 In  IP 192.168.1.2.http > 172.16.0.2.36016: Flags [P.], seq 1:491, ack 331, win 507, options [nop,nop,TS val 1050491360 ecr 4079365404], length 490: HTTP: HTTP/1.1 404 Not Found
15:24:30.005082 wlp2s0 Out IP 192.168.1.2.http > 172.16.0.2.36016: Flags [P.], seq 1:491, ack 331, win 507, options [nop,nop,TS val 1050491360 ecr 4079365404], length 490: HTTP: HTTP/1.1 404 Not Found
15:24:35.082889 wlp2s0 In  IP 172.16.0.2.36018 > 192.168.1.2.http: Flags [P.], seq 1:328, ack 1, win 502, options [nop,nop,TS val 4079370483 ecr 1050496437], length 327: HTTP: GET /admin HTTP/1.1
15:24:35.082894 enp0s25 Out IP 172.16.0.2.36018 > 192.168.1.2.http: Flags [P.], seq 1:328, ack 1, win 502, options [nop,nop,TS val 4079370483 ecr 1050496437], length 327: HTTP: GET /admin HTTP/1.1
15:24:35.084156 enp0s25 In  IP 192.168.1.2.http > 172.16.0.2.36018: Flags [P.], seq 1:491, ack 328, win 507, options [nop,nop,TS val 1050496439 ecr 4079370483], length 490: HTTP: HTTP/1.1 404 Not Found
15:24:35.084167 wlp2s0 Out IP 192.168.1.2.http > 172.16.0.2.36018: Flags [P.], seq 1:491, ack 328, win 507, options [nop,nop,TS val 1050496439 ecr 4079370483], length 490: HTTP: HTTP/1.1 404 Not Found
15:24:42.662626 wlp2s0 In  IP 172.16.0.2.36020 > 192.168.1.2.http: Flags [P.], seq 1:576, ack 1, win 502, options [nop,nop,TS val 4079378062 ecr 1050504017], length 575: HTTP: GET /phpMyAdmin/ HTTP/1.1
15:24:42.662629 enp0s25 Out IP 172.16.0.2.36020 > 192.168.1.2.http: Flags [P.], seq 1:576, ack 1, win 502, options [nop,nop,TS val 4079378062 ecr 1050504017], length 575: HTTP: GET /phpMyAdmin/ HTTP/1.1
15:24:42.691576 enp0s25 In  IP 192.168.1.2.http > 172.16.0.2.36020: Flags [P.], seq 1:6038, ack 576, win 505, options [nop,nop,TS val 1050504046 ecr 4079378062], length 6037: HTTP: HTTP/1.1 200 OK
```

## 3) Logging in phpMyAdmin


Attacker between `15:24:56` and `15:26:30` tries different username password pairs to gain access to bank database.

`tcpdump -A -s 0 -i -any -r greenforestbank-serwer.pcap host 192.168.1.2 and host 172.16.0.2 and tcp port 80 | grep username`

gives output:

todo: get time here


```
reading from file greenforestbank-serwer.pcap, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144
Warning: interface names might be incorrect
set_session=gnunb0qcljqgb6atakglfj5ei7&pma_username=root&pma_password=root&server=1&route=%2F&token=7126656a573c7b38547828784f256f3c
set_session=6fkh05uvoemqs74cloabsahsc6&pma_username=admin&pma_password=admin&server=1&route=%2F&token=6045232e5f266c372452324459426f53
set_session=910dj2c5moabbu5cnoauc1cad6&pma_username=guest&pma_password=guest&server=1&route=%2F&token=3977452f612f426a2a6a267e5e493579
set_session=4bpu022mhmbfvom4ledfocmolo&pma_username=administrator&pma_password=administrator&server=1&route=%2F&token=7e63335d2d55514d3c5f232a6a6d4d39
set_session=mvl2q5vs5kfdhefb41gc06jh61&pma_username=root&pma_password=&server=1&route=%2F&token=5b752e6070305546285722494b76757b
set_session=i060g1rk3aq2mqts175ee16aum&pma_username=root&pma_password=1234567890&server=1&route=%2F&token=49565a3843626f7a6f56445d4562497b
set_session=n0dcv72rmjaakd6k649frjbbgr&pma_username=root&pma_password=0123456789&server=1&route=%2F&token=4c2237276c6e3822564d6e4958612555
set_session=ru5m7363u1cggrq450tnhnb7o9&pma_username=root&pma_password=1234&server=1&route=%2F&token=2277435677245334786e2d2a2e25344c
set_session=5nojjhbi0jb75evnb2p9fr02ep&pma_username=root&pma_password=12345678&server=1&route=%2F&token=5f6f7e2269253b65476c2f2b3e316135
set_session=ht79vgjo9vc6v9cm6a5ap65nf7&pma_username=root&pma_password=abcdefghijk&server=1&route=%2F&token=7d25606053685159577c4f2e345a4938
set_session=embhs92a8s1m4cc6odshu92gd3&pma_username=root&pma_password=abcd&server=1&route=%2F&token=526343643a306c53377050736c5b6261
set_session=abuv2cbk4bcs6jtnoo222mh4sc&pma_username=szef&pma_password=szef&server=1&route=%2F&token=543b216d7d6b6d7f526f7956285b7c6b
```

We can further confirm this assumption by looking at `auth.log`:

`cat auth.log | grep 'user denied`


```
Dec  8 15:25:04 serwer phpMyAdmin[3933]: user denied: admin (mysql-denied) from 172.16.0.2
Dec  8 15:25:20 serwer phpMyAdmin[3929]: user denied: guest (mysql-denied) from 172.16.0.2
Dec  8 15:25:34 serwer phpMyAdmin[3936]: user denied: administrator (mysql-denied) from 172.16.0.2
Dec  8 15:25:41 serwer phpMyAdmin[3931]: user denied: root (empty-denied) from 172.16.0.2
Dec  8 15:25:52 serwer phpMyAdmin[4137]: user denied: root (mysql-denied) from 172.16.0.2
Dec  8 15:26:01 serwer phpMyAdmin[3932]: user denied: root (mysql-denied) from 172.16.0.2
Dec  8 15:26:05 serwer phpMyAdmin[3932]: user denied: root (mysql-denied) from 172.16.0.2
Dec  8 15:26:10 serwer phpMyAdmin[3932]: user denied: root (mysql-denied) from 172.16.0.2
Dec  8 15:26:17 serwer phpMyAdmin[3930]: user denied: root (mysql-denied) from 172.16.0.2
Dec  8 15:26:21 serwer phpMyAdmin[3930]: user denied: root (mysql-denied) from 172.16.0.2
```

Finally, attacker logs in to the phpMyAdmin panel by using `szef-szef` pair.

# System time

# Privillage level
